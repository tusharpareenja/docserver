version: '3.8'

services:
  onlyoffice:
  build:
    context: ..
    dockerfile: docker/onlyoffice/Dockerfile.arm64
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_PORT=5432
      version: '3.8'

      services:
        onlyoffice:
          build:
              context: ..
              dockerfile: docker/onlyoffice/Dockerfile.arm64
          ports:
            - "80:80"
            - "443:443"
          environment:
            - DB_TYPE=postgres
            - DB_HOST=postgres
            - DB_PORT=5432
            - DB_NAME=onlyoffice
            - DB_USER=onlyoffice
            - DB_PASSWORD=onlyoffice
          depends_on:
            - postgres
            - rabbitmq
            - redis

        postgres:
          image: postgres:latest
          volumes:
            - postgres_data:/var/lib/postgresql/data
          environment:
            version: '3.8'

            services:
              onlyoffice:
                build:
                  context: ..
                  dockerfile: docker/onlyoffice/Dockerfile.arm64
                ports:
                  - "80:80"
                  - "443:443"
                environment:
                  DB_TYPE: "postgres"
                  DB_HOST: "postgres"
                  DB_PORT: "5432"
                  DB_NAME: "onlyoffice"
                  DB_USER: "onlyoffice"
                  DB_PASSWORD: "onlyoffice"
                depends_on:
                  - postgres
                  - rabbitmq
                  - redis

              postgres:
                image: postgres:latest
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                environment:
                  POSTGRES_DB: "onlyoffice"
                  POSTGRES_USER: "onlyoffice"
                  POSTGRES_PASSWORD: "your_password"

              rabbitmq:
                image: rabbitmq:management
                ports:
                  - "15672:15672"
                  - "5672:5672"
                environment:
                  RABBITMQ_DEFAULT_USER: "user"
                  RABBITMQ_DEFAULT_PASS: "password"

              redis:
                image: redis:latest
                volumes:
                  - redis_data:/data

            volumes:
              postgres_data:
              redis_data: